<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../paper-tooltip/paper-tooltip.html">
<link rel="import" href="../iron-icon/iron-icon.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-dialog/paper-dialog.html">
<link rel="import" href="../neon-animation/animations/scale-up-animation.html">
<link rel="import" href="../neon-animation/animations/fade-out-animation.html">
<link rel="import" href="../paper-spinner/paper-spinner.html">

<link rel="import" href="dsc-image-upload-icons.html">
<link rel="import" href="dsc-cropper.html">

<dom-module id="dsc-polymer-image-upload">

  <template>

    <style>
      :host {
        @apply(--paper-font-common-base);
      }

      #dsc-image-upoload {
        position: relative;
      }

      #spinnerOverlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: #eeeeee;
        z-index: 10;
        opacity: 0.4;
      }

      #spinnerContainer {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 20;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      #spinnerOverlay[hidden],
      #spinnerContainer[hidden] {
        display: none;
      }

      #container {
        width: 500px;
      }

      #upload-header {
        display: flex;
        align-items: center;
      }

      #btn-select {
        margin-right: 20px;
      }

      #help {
        width: 17px;
        height: 17px;
      }

      #label-qtd {
        margin-left: auto;
        padding-right: 7px;
        font-size: 12px;
      }

      .upload-item {
        display: flex;
        align-items: center;
        box-sizing: border-box;
        font: inherit;
        outline-width: 0;
        -moz-user-select: none;
        -ms-user-select: none;
        -webkit-user-select: none;
        user-select: none;
        z-index: 0;
        padding: 0.7em 0.57em;
        border-top: 1px solid #e0e0e0;
      }

      .upload-item:first-of-type {
        margin-top: 15px;
      }

      .upload-item .img-container {
        transition: opacity 0.3s;
        -webkit-transition: opacity 0.3s;
        cursor: zoom-in;
      }

      .upload-item .img-container:hover {
        opacity: 0.5;
      }

      .upload-item:first-of-type .btn-up {
        display: none;
      }

      .upload-item:last-of-type .btn-down {
        display: none;
      }

      .upload-item:last-of-type .btn-up {
        margin-right: 40px;
      }

      .high-width .width,
      .low-width .width,
      .high-height .height,
      .low-height .height,
      .high-size .size,
      .different-ratio .ratio,
      .repeated-name .name,
      .pattern-name .name,
      .pattern-description .text-description {
        color: red;
      }

      .text-container {
        padding-left: 10px;
        text-align: left;
      }

      .text-details {
        font-size: 10px;
        color: #666;
      }

      .text-description {
        font-size: 10px;
      }

      .icons-container {
        margin-left: auto;
      }

    </style>

    <div id="dsc-image-upoload">

      <div id="spinnerOverlay" hidden$="[[!isLoading]]"></div>
      <div id="spinnerContainer" hidden$="[[!isLoading]]">
        <paper-spinner active$="[[isLoading]]"></paper-spinner>
      </div>

      <input type="file" id="browse" hidden multiple on-change="_readFiles" accept="image/*">

      <div id="preview"></div>

      <div id="upload-header">
        <paper-button id="btn-select" disabled="[[qtdLimitReached]]" raised class="custom indigo" on-click="_selectFiles">
          <iron-icon icon="image-upload-icons:file-upload"></iron-icon>
          SELECT FILES
        </paper-button>
        <div id="label-qtd">
          <iron-icon id="help" icon="image-upload-icons:help-outline"></iron-icon>
          <paper-tooltip for="help" position="bottom" animation-delay="0">
            The resulting images must have the following attributes:<br>
            - <b>Width</b> between <b>{{minWidth}}</b> and <b>{{maxWidth}}</b> px;<br>
            - <b>Height</b> between <b>{{minHeight}}</b> and <b>{{maxHeight}}</b> px;<br>
            - Max file <b>size</b> <b>{{maxFileSize}}</b> bytes;
          </paper-tooltip>
          {{qtdFiles}} of {{maxFiles}}
        </div>
      </div>

      <div id="itensContainer"></div>

      <paper-dialog id="dialogCrop" modal>
        <div id="container"></div>
        <div class="buttons">
          <paper-button dialog-confirm autofocus>Cancel</paper-button>
          <paper-button id="dialog-crop-confirm">Apply</paper-button>
        </div>
      </paper-dialog>

      <paper-dialog id="dialogPreview" modal>
        <div id="previewContainer"></div>
        <div class="buttons">
          <paper-button dialog-confirm autofocus>Close</paper-button>
        </div>
      </paper-dialog>

    </div>
  </template>

  <script>
    Polymer({
      is: 'dsc-polymer-image-upload',

      properties: {

        /**
         * Indicate loadind state to show spinner.
         */
        isLoading: {
          type: Boolean,
          value: false,
        },

        /**
         * Flag indicate have one or more itens.
         */
        hasImages: {
          type: Boolean,
          value: false,
        },

        /**
         * Total itens processed.
         */
        qtdFiles: {
          type: Number,
          value: 0,
          observer: '_qtdFilesChanged',
        },

        /**
         * Quantity of files on rocessing queue.
         */
        qtdPendingFiles: {
          type: Number,
          value: 0,
          observer: '_qtdPendingFilesChanged',
        },

        /**
         * True if qtd limit 'maxFiles' is reached.
         */
        qtdLimitReached: {
          type: Boolean,
          value: false,
        },

        /**
         * Maximum number of files.
         */
        maxFiles: {
          type: String,
          value: 5,
        },

        /**
         * Max file size in bytes
         */
        maxFileSize: {
          type: Number,
          value: 1000 * 1024, // 1MB
        },

        /**
         * Min image width in px.
         */
        minWidth: {
          type: Number,
          value: 320,
        },

        /**
         * Max image width in px.
         */
        maxWidth: {
          type: Number,
          value: 1920,
        },

        /**
         * Min image height in px.
         */
        minHeight: {
          type: Number,
          value: 240,
        },

        /**
         * Max image height in px.
         */
        maxHeight: {
          type: Number,
          value: 1080,
        },

        /**
         * Force aspect ratio. Ex: 16:9, 4:3, 1:1, 2:3 or 0 for free.
         */
        aspectRatio: {
          type: String,
          value: '1:1',
          observer: '_aspectRatioChanged',
        },

        /**
         * Numeric calculate aspect ratio by aspectRatio propertie. Ex: 4:3 equal 0.666666667.
         * Nan for free.
         */
        computedAspectRatio: {
          type: Number,
        },

        /**
         * Flag to image file parse.
         */
        useBlob: {
          type: Boolean,
        },

        /**
         * Cropper plugin object.
         * @see https://fengyuanchen.github.io/cropperjs/
         */
        dscCropper: {
          type: Object,
        },

        /**
         * Array of images object data and info. Ex:
         *  [
         *    {
         *      order: 1,
         *      src: "data:image/jpeg;base64,/9j/4AAQSkZJRgtgsrtgserfdhdfh...",
         *      width: 640,
         *      height: 480,
         *      size: 198542,
         *      name: 'teste.jpg',
         *      type: 'image/jpg',
         *      description: "Optional image description"
         *      errors: ['low-width', 'high-size']
         *    },
         *    ...
         *  ]
         */
        items: {
          type: Array,
          value: [],
          notify: true,
        },

      },

      /**
       * Generate new object ID.
       *
       * @return {string}
       */
      _generateObjectId: function() {
        var timestamp = (new Date().getTime() / 1000 | 0).toString(16);
        return timestamp + 'xxxxxxxxxxxxxxxx'.replace(/[x]/g, function() {
            return (Math.random() * 16 | 0).toString(16);
        }).toLowerCase();
      },

      /**
       * Return next order to nex item (last + 1).
       *
       * @return {number}
       */
      _generateOrder: function() {
        var lastOrder = 0;
        if (this.items.length > 0) {
          lastOrder = Math.max.apply(
            null,
            this.items.map(
              function(o) {
                return o.order;
              }
            )
          );
        }
        return lastOrder + 1;
      },

      /**
       * Return item ID event of button click.
       *
       * @param {object} event Object of event.
       *
       * @return {string}
       */
      _getIdByButtonEvent: function(event) {
        var thisButton = event.currentTarget;
        var parent = thisButton.closest('.upload-item');
        var attrId = parent.getAttribute('id');
        var id = attrId.replace('item-', '');
        return id;
      },

      /**
       * Return item object by ID
       *
       * @param {string} id Item ID.
       *
       * @return {object}
       */
      _getItemById: function(id) {
        for(var i = 0; i < this.items.length; i++) {
          if (this.items[i].id == id) {
            return this.items[i];
          }
        }
      },

      /**
       * Show preview dialog.
       *
       * @param {object} e Object of event.
       */
      _onPreview: function(e) {
        this.isLoading = true;
        var id = this._getIdByButtonEvent(e);
        var item = this._getItemById(id);
        var windowHeight = window.innerHeight - 200;
        var that = this;
        // iron image
        var image = new Image();
        image.setAttribute('style', 'display:block;max-width:100%;max-height:' + windowHeight + 'px;');
        image.onload = function() {
          // that.$.previewContainer.innerHTML = '';
          Polymer.dom(that.$.previewContainer).innerHTML = '';
          // that.$.previewContainer.appendChild(this);
          Polymer.dom(that.$.previewContainer).appendChild(this);
          that.$.dialogPreview.open();
          that.isLoading = false;
        };
        image.setAttribute('src', item.src);
      },

      /**
       * Down one position (items must be preordered before changing position).
       *
       * @param {object} e Object of event.
       */
      _onDownItem: function(e) {
        this.isLoading = true;
        var id = this._getIdByButtonEvent(e);
        var item = this._getItemById(id);
        var itemPosition = null;
        var previousItemPosition = null;
        for(var i = 0; i < this.items.length; i++) {
          if (item.id === this.items[i].id) {
            itemPosition = i;
            if (this.items[i - 1] != 'undefined') {
              previousItemPosition = i - 1;
            }
          }
        }
        if (itemPosition !== null && previousItemPosition !== null) {
          var itemOrder = item.order;
          var previousOrder = this.items[previousItemPosition].order;
          this.items[itemPosition].order = previousOrder;
          this.items[previousItemPosition].order = itemOrder;
          this._refreshUI();
        }
        this.isLoading = false;
      },

      /**
       * Up one position (items must be preordered before changing position).
       *
       * @param {object} e Object of event.
       */
      _onUpItem: function(e) {
        this.isLoading = true;
        var id = this._getIdByButtonEvent(e);
        var item = this._getItemById(id);
        var itemPosition = null;
        var nextItemPosition = null;
        for(var i = 0; i < this.items.length; i++) {
          if (item.id === this.items[i].id) {
            itemPosition = i;
            if (this.items[i + 1] != 'undefined') {
              nextItemPosition = i + 1;
            }
          }
        }
        if (itemPosition !== null && nextItemPosition !== null) {
          var itemOrder = item.order;
          var nextOrder = this.items[nextItemPosition].order;
          this.items[itemPosition].order = nextOrder;
          this.items[nextItemPosition].order = itemOrder;
          this._refreshUI();
        }
        this.isLoading = false;
      },

      /**
       * Trigger hidden input file click.
       */
      _selectFiles: function() {
        this.$.browse.value = '';
        this.$.browse.click();
      },

      _qtdFilesChanged: function() {
        this.hasImages = (this.qtdFiles > 0);
        this.qtdLimitReached = (this.qtdFiles >= this.maxFiles);
      },

      /**
       * Pending files in queue for processing.
       */
      _qtdPendingFilesChanged: function() {
        this.isLoading = (this.qtdPendingFiles > 0);
      },

      /**
       * Observer aspectRatio to update calculatedAspectRatio.
       */
      _aspectRatioChanged: function() {
        // TODO: validate format
        var arr = this.aspectRatio.split(':');
        this.computedAspectRatio = parseInt(arr[0]) / parseInt(arr[1]);
      },

      /**
       * Proccess files selected in input file.
       *
       * @param {object} e Object of event.
       */
      _readFiles: function(e) {
        this.isLoading = true;
        var that = this;
        // Let's store the FileList Array into a variable:
        // https://developer.mozilla.org/en-US/docs/Web/API/FileList
        var files = e.target.files;
        // Let's create an empty `errors` String to collect eventual errors into:
        var errors = '';
        if (! files) {
          errors += 'File upload not supported by your browser.';
        }
        // Check for `files` (FileList) support and if contains at least one file:
        if (files && files[0]) {
          this.qtdPendingFiles = this.qtdPendingFiles + files.length;
          // Iterate over every File object in the FileList array
          for(var i=0; i < files.length; i++) {
            // Let's refer to the current File as a `file` variable
            // https://developer.mozilla.org/en-US/docs/Web/API/File
            var file = files[i];
            // Test the `file.name` for a valid image extension:
            // (pipe `|` delimit more image extensions)
            // The regex can also be expressed like: /\.(png|jpe?g|gif)$/i
            if ( (/\.(png|jpeg|jpg|gif)$/i).test(file.name) ) {
              // SUCCESS! It's an image!
              // Send our image `file` to our `_readImage` function!
              that._readImage(file);
            } else {
              errors += file.name + ' Unsupported Image extension\n';
            }
          }
        }
        // Notify the user for any errors (i.e: try uploading a .txt file)
        if (errors) {
          alert(errors);
        }
      },

      /**
       * Generate image and add item from imput file queue.
       *
       * @param {object} file Object of item.
       */
      _readImage: function(file) {
        var that = this;
        // Create a new FileReader instance
        // https://developer.mozilla.org/en/docs/Web/API/FileReader
        var reader = new FileReader();
        // Once a file is successfully readed:
        reader.addEventListener('load', function() {
          // At this point `reader.result` contains already the Base64 Data-URL
          // and we've could immediately show an image using
          // `elPreview.insertAdjacentHTML("beforeend", "<img src='"+ reader.result +"'>");`
          // But we want to get that image's width and height px values!
          // Since the File Object does not hold the size of an image
          // we need to create a new image and assign it's src, so when
          // the image is loaded we can calculate it's width and height:
          var image = new Image();
          image.addEventListener('load', function() {
            var imgInfo = {
              name: file.name,
              width: image.width,
              height: image.height,
              type: file.type,
              size: file.size,
              src: image.src,
            };
            // Finally append our created image and the HTML info string to our `#preview`
            that._addItem(this, imgInfo);
            // If we set the variable `useBlob` to true:
            // (Data-URLs can end up being really large
            // `src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAA...........etc`
            // Blobs are usually faster and the image src will hold a shorter blob name
            // src="blob:http%3A//example.com/2a303acf-c34c-4d0a-85d4-2136eef7d723"
            if (that.useBlob) {
              // Free some memory for optimal performance
              window.URL.revokeObjectURL(image.src);
            }
            // decrease pending qtd
            that.qtdPendingFiles--;
          });
          image.src = that.useBlob ? window.URL.createObjectURL(file) : reader.result;
          image.removeEventListener('load', function() {});
        });
        // https://developer.mozilla.org/en-US/docs/Web/API/FileReader/readAsDataURL
        reader.readAsDataURL(file);
        reader.removeEventListener('load', function() {});
      },

      /**
       * Refresh ui by this.items state.
       */
      _refreshUI: function() {
        // clear variables
        this.isLoading = true;
        this.hasImages = false;
        this.qtdFiles = 0;
        this.qtdPendingFiles = 0;
        this.qtdLimitReached = false;
        var clone = JSON.parse(JSON.stringify(this.items));
        this.items = [];
        this.setData(clone);
        this.isLoading = false;
      },

      /**
       * Add item to array and call render ui.
       *
       * @param {object} img Image dom object.
       * @param {object} imgInfo Object of item info.
       * @param {string} id ID of item.
       */
      _addItem: function(img, imgInfo, id) {
        if (this.qtdLimitReached === false) {
          imgInfo.id = id || this._generateObjectId();
          imgInfo.order = imgInfo.order || this._generateOrder();
          this.items.push(imgInfo);
          var divItem = this._renderItem(img, imgInfo);
          // this.$.itensContainer.appendChild(divItem);
          Polymer.dom(this.$.itensContainer).appendChild(divItem);
          this.qtdFiles ++;
          // revalidate
          this._validateAll();
        }
      },

      /**
       * Render visual control item.
       *
       * @param {object} img Image dom object.
       * @param {object} imgInfo Object of item info.
       *
       * @return {object} Dom element.
       */
      _renderItem: function(img, imgInfo) {
        // div.upload-item
        var divItem = document.createElement('div');
        divItem.setAttribute('class', 'upload-item');
        divItem.setAttribute('id', 'item-' + imgInfo.id);
        // iron image
        var ironImage = document.createElement('iron-image');
        ironImage.setAttribute('style', 'width:55px; height:55px;');
        ironImage.setAttribute('sizing', 'cover'); // contain
        ironImage.setAttribute('src', img.src);
        this.listen(ironImage, 'tap', '_onPreview');
        // div.img-container
        var divImg = document.createElement('div');
        divImg.setAttribute('class', 'img-container');
        divImg.appendChild(ironImage);
        // div.text-container
        var divText = document.createElement('div');
        divText.setAttribute('class', 'text-container');
        // name
        var divName = document.createElement('div');
        divName.setAttribute('class', 'name');
        divName.innerText = imgInfo.name;
        divText.appendChild(divName);
        // details
        var divDetails = document.createElement('div');
        divDetails.setAttribute('class', 'text-details');
        // span.width
        var spanWidth = document.createElement('span');
        spanWidth.setAttribute('class', 'width');
        spanWidth.innerText = imgInfo.width;
        // span.vs
        var spanVs = document.createElement('span');
        spanVs.innerText = ' x ';
        // span.height
        var spanHeight = document.createElement('span');
        spanHeight.setAttribute('class', 'height');
        spanHeight.innerText = imgInfo.height;
        // span.separator
        var spanSeparator = document.createElement('span');
        spanSeparator.innerText = '  -  ';
        // aspect ratio
        var spanRatio = document.createElement('span');
        spanRatio.setAttribute('class', 'ratio');
        spanRatio.innerText = this._getLabelAspectRatioBySize(imgInfo.width, imgInfo.height);
        // span.separator
        var spanSeparator2 = document.createElement('span');
        spanSeparator2.innerText = '  -  ';
        // span.size
        var spanSize = document.createElement('span');
        spanSize.setAttribute('class', 'size');
        spanSize.innerText = this._getLabelSize(imgInfo.size);

        divDetails.appendChild(spanWidth);
        divDetails.appendChild(spanVs);
        divDetails.appendChild(spanHeight);
        divDetails.appendChild(spanSeparator);
        divDetails.appendChild(spanRatio);
        divDetails.appendChild(spanSeparator2);
        divDetails.appendChild(spanSize);

        divText.appendChild(divDetails);
        // description
        if (typeof imgInfo.description != 'undefined') {
          var divDescription = document.createElement('div');
          divDescription.setAttribute('class', 'text-description');
          divDescription.innerText = imgInfo.description;
          divText.appendChild(divDescription);
        }
        // div.icons-container
        var divIcons = document.createElement('div');
        divIcons.setAttribute('class', 'icons-container');
        // paper-icon-button (up)
        var buttonUp = document.createElement('paper-icon-button');
        buttonUp.setAttribute('icon', 'image-upload-icons:arrow-upward');
        buttonUp.setAttribute('title', 'Up');
        buttonUp.setAttribute('class', 'btn-up');
        this.listen(buttonUp, 'tap', '_onDownItem');
        divIcons.appendChild(buttonUp);
        // paper-icon-button (down)
        var buttonDown = document.createElement('paper-icon-button');
        buttonDown.setAttribute('icon', 'image-upload-icons:arrow-downward');
        buttonDown.setAttribute('title', 'Down');
        buttonDown.setAttribute('class', 'btn-down');
        this.listen(buttonDown, 'tap', '_onUpItem');
        divIcons.appendChild(buttonDown);
        // paper-icon-button (edit)
        var buttonEdit = document.createElement('paper-icon-button');
        buttonEdit.setAttribute('icon', 'image-upload-icons:create');
        buttonEdit.setAttribute('title', 'Edit image');
        this.listen(buttonEdit, 'tap', '_editItem');
        divIcons.appendChild(buttonEdit);
        // paper-icon-button (remove)
        var buttonRemove = document.createElement('paper-icon-button');
        buttonRemove.setAttribute('icon', 'image-upload-icons:clear');
        buttonRemove.setAttribute('title', 'Remove image');
        this.listen(buttonRemove, 'tap', '_removeItem');
        divIcons.appendChild(buttonRemove);

        divItem.appendChild(divImg);
        divItem.appendChild(divText);
        divItem.appendChild(divIcons);

        return divItem;
      },

      /**
       * Calculate greatest common divisor for purposes of presentation of
       * aspect ratio.
       *
       * @param {number} width Width size.
       * @param {number} height Height size.
       *
       * @return {number} GCD of aspect ratio.
       */
      _gcdBySize: function(width, height) {
        return (height == 0) ? width : this._gcdBySize(height, width%height);
      },

      /**
       * Calculate greatest common divisor for purposes of presentation of
       * aspect ratio.
       *
       * @param {number} width Width size.
       * @param {number} height Height size.
       *
       * @return {number} Calculated aspect ratio.
       */
      _getAspectRatioBySize: function(width, height) {
        var gcd = this._gcdBySize(width, height);
        return (width/gcd) / (height/gcd);
      },

      /**
       * Return aspectratio human redable. Ex: '4:3'.
       *
       * @param {number} width Width size.
       * @param {number} height Height size.
       *
       * @return {string}
       */
      _getLabelAspectRatioBySize: function(width, height) {
        var gcd = this._gcdBySize(width, height);
        return width/gcd + ':' + height/gcd;
      },

      /**
       * Return human redable size lebal by bytes size.
       *
       * @param {number} bytes Size in bytes.
       *
       * @return {string}
       */
      _getLabelSize: function(bytes) {
        var sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
        if (bytes == 0) return '0 Byte';
        var i = parseInt(Math.floor(Math.log(bytes) / Math.log(1024)));
        return Math.round(bytes / Math.pow(1024, i), 2) + ' ' + sizes[i];
      },

      /**
       * Set errors on items array and UI.
       */
      _validateAll: function() {
        // each all itens
        for(var i = 0; i < this.items.length; i++) {
          // create array of erros
          var arrStatus = [];
          if (this.maxWidth > 0 && this.items[i].width > this.maxWidth) {
            arrStatus.push('high-width');
          }
          if (this.minWidth > 0 && this.items[i].width < this.minWidth) {
            arrStatus.push('low-width');
          }
          if (this.maxHeight > 0 && this.items[i].height > this.maxHeight) {
            arrStatus.push('high-height');
          }
          if (this.minHeight > 0 && this.items[i].height < this.minHeight) {
            arrStatus.push('low-height');
          }
          if (this.items[i].size > this.maxFileSize) {
            arrStatus.push('high-size');
          }
          if (! /^[0-9a-zA-Z\_\-\.]+$/.test(this.items[i].name)) {
            arrStatus.push('pattern-name');
          }
          if (! /^[a-zA-ZçÇãÃáÁàÀéÉêÊíÍõÕóÓôÔúÚ0-9 .,;!@%_-]+$/.test(this.items[i].description)) {
            arrStatus.push('pattern-description');
          }
          // aspect ratio
          var ratio = this._getAspectRatioBySize(this.items[i].width, this.items[i].height);
          var ratioDiff = Math.abs(ratio - this.computedAspectRatio);
          if (ratioDiff > 0.02) {
            arrStatus.push('different-ratio');
          }
          var count = 0;
          for (var j = 0; j < this.items.length; j++) {
            if (this.items[i].name == this.items[j].name) {
              count ++;
            }
          }
          if (count > 1) {
            arrStatus.push('repeated-name');
          }
          // set errors on items objects
          this.items[i].errors = arrStatus;
          // set errors on UI
          // this.$$('#item-' + this.items[i].id).setAttribute('class', 'upload-item ' + arrStatus.join(' '));
          Polymer.dom(this.$$('#item-' + this.items[i].id)).setAttribute('class', 'upload-item ' + arrStatus.join(' '));
        }
      },

      /**
       * Event caled after crop result ok.
       *
       * @param {object} e Object of event.
       */
      _onCropResult: function(e) {
        var item = e.detail;
        this._updateItem(item);
        this.$.dialogCrop.close();
        // TODO: remove listeners
      },

      /**
       * Edit item (open dialog)
       *
       * @param {object} e Object of event.
       */
      _editItem: function(e) {
        this.isLoading = true;
        var id = this._getIdByButtonEvent(e);
        var item = this._getItemById(id);
        // open dialog
        this.$.dialogCrop.open();
        this.dscCropper = document.createElement('dsc-cropper');
        this.dscCropper.id = item.id;
        this.dscCropper.type = item.type;
        this.dscCropper.name = item.name;
        this.dscCropper.description = item.description;
        this.dscCropper.src = item.src;
        this.dscCropper.aspectRatio = this.computedAspectRatio;
        this.dscCropper.minWidth = this.minWidth;
        this.dscCropper.maxWidth = this.aspectRamaxWidthtio;
        this.dscCropper.minHeight = this.minHeight;
        this.dscCropper.maxHeight = this.maxHeight;
        this.dscCropper.regions = this.officesRegions;
        this.dscCropper.cities = this.officesCities;
        this.listen(this.dscCropper, 'crop-result', '_onCropResult');
        this.listen(this.$$('#dialog-crop-confirm'), 'tap', 'crop');
        // this.$.container.innerHTML = '';
        Polymer.dom(this.$.container).innerHTML = '';
        // this.$.container.appendChild(this.dscCropper);
        Polymer.dom(this.$.container).appendChild(this.dscCropper);
        this.isLoading = false;
        Polymer.updateStyles();
      },

      /**
       * Remove item from array of itens and UI.
       *
       * @param {object} e Object of event.
       */
      _removeItem: function(e) {
        var id = this._getIdByButtonEvent(e);
        // remove array index
        for(var i = 0; i < this.items.length; i++) {
          if (this.items[i].id == id) {
            this.items.splice(i, 1);
          }
        }
        this.qtdFiles --;
        // remove ui
        this.$$('#item-' + id).remove();
        // revalidate
        this._validateAll();
      },

      /**
       * Dialog Aplly click
       */
      crop: function() {
        this.dscCropper.crop();
      },

      /**
       * Update items array and UI after edit result.
       *
       * @param {object} item Item object.
       */
      _updateItem: function(item) {
        // search item
        for(var i = 0; i < this.items.length; i++) {
          if (this.items[i].id == item.id) {
            // update object
            this.items[i].src = item.src;
            this.items[i].width = item.width;
            this.items[i].height = item.height;
            this.items[i].size = item.size;
            this.items[i].name = item.name;
            this.items[i].description = item.description;
            // update ui
            var currentUi = Polymer.dom(this.root).querySelector('#item-' + item.id);
            var image = new Image();
            image.src = item.src;
            var divItem = this._renderItem(image, this.items[i]);
            currentUi.replaceWith(divItem);
            // revalidate
            this._validateAll();
          }
        }
      },

      /**
       * On component ready.
       */
      ready: function() {
        window.URL = window.URL || window.webkitURL;
        this.useBlob = false && window.URL; // Set to `true` to use Blob instead of Data-URL
        this._aspectRatioChanged();
      },

      /**
       * Public function to fill existent items into component.
       *
       * @param {array} items Array of intems objects.
       */
      setData: function(items) {
        // TODO: validate param

        // Order array of items by field 'order'.
        items.sort(function(a, b) {
          return parseFloat(a.order) - parseFloat(b.order);
        });
        // remove UI items
        // this.$.itensContainer.innerHTML = '';
        Polymer.dom(this.$.itensContainer).innerHTML = '';
        for(var i = 0; i < items.length; i++) {
          var image = new Image();
          image.src = items[i].src;
          this._addItem(image, items[i], items[i].id);
        }
      },

      /**
       * Public function that returns JSON object of items.
       * It is recommended to check the 'isValid' method before getting the items.
       *
       * @return {array} Array of intems objects.
       */
      getData: function() {
        var clone = JSON.parse(JSON.stringify(this.items));
        clone.forEach(function(v) {
            delete v.errors;
          }
        );
        return clone;
      },

      /**
       * Public function to validade items.
       *
       * @return {boolean}
       */
      isValid: function() {
        // each all itens
        for(var i = 0; i < this.items.length; i++) {
          if (this.items[i].errors.length > 0) {
            return false;
          }
        }
        return true;
      },
    });
  </script>

</dom-module>
